name: Install MODFLOW
description: Install & cache MODFLOW 6 and related programs.
inputs:
  github_token:
    description: GitHub API access token
    required: true
  path:
    description: Path to store the executables (e.g. a bin directory)
    required: true
  repo:
    description: Repository to install executables from ('executables', 'modflow6', or 'modflow6-nightly-build')
    required: false
    default: executables
outputs:
  cache-hit:
    description: Whether a matching entry was found in the Github Actions cache
    value: ${{ steps.cache_executables.outputs.cache-hit }}
runs:
  using: composite
  steps:
    - if: runner.os != 'Windows'
      shell: bash
      run: |
        normalized=$(python3 $GITHUB_ACTION_PATH/normalize_path.py "${{ inputs.path }}")
        echo "Normalized bin dir path: $normalized"
        echo "MODFLOW_BIN_PATH=$normalized" >> $GITHUB_ENV
        mkdir -p "$normalized"

    - if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $normalized = $(python3 $(Join-Path -Path "$env:GITHUB_ACTION_PATH" -ChildPath "normalize_path.py") "${{ inputs.path }}")
        echo "Normalized bin dir path: $normalized"
        echo "MODFLOW_BIN_PATH=$normalized" | Out-File -FilePath "$env:GITHUB_ENV" -Encoding utf8 -Append
        md -Force "$normalized"

    - name: Check release
      shell: bash
      run: |
        # get info for the executables repository's latest release
        release_json=$(curl -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_TOKEN }}" "https://api.github.com/repos/MODFLOW-USGS/${{ inputs.repo }}/releases/latest") || echo "No release to check, skipping"

        # get asset ID of the release's metadata file, if one exists
        get_asset_id="
        import json
        import sys
        pattern = 'code.json'
        release = json.load(sys.stdin, strict=False)
        metadata = next(iter([a for a in release['assets'] if a['name'] == pattern]), None)
        print(dict(metadata)['id'] if metadata else '')
        "
        asset_id=$(echo "$release_json" | python3 -c "$get_asset_id") || echo "No release to check, skipping"

        # asset_id is empty if metadata file asset wasn't found
        if [ ${#asset_id} -gt 0 ]; then
           curl -H "Accept: application/octet-stream" -H "Authorization: Bearer $GH_TOKEN }}" "https://api.github.com/repos/MODFLOW-USGS/${{ inputs.repo }}/releases/assets/$asset_id" >> code.json
        else
          # give hashFiles an empty file to hash
          touch code.json
        fi
      env:
        GH_TOKEN: ${{ inputs.github_token }}

    - name: Cache executables
      id: cache_executables
      uses: actions/cache@v3
      with:
        path: ${{ env.MODFLOW_BIN_PATH }}
        key: modflow-${{ runner.os }}-${{ inputs.repo }}-${{ hashFiles('code.json') }}

    - name: Install executables
      if: steps.cache_executables.outputs.cache-hit != 'true'
      shell: bash
      run: |
        if command -v get-modflow &> /dev/null
        then
          echo "get-modflow command is available, running get-modflow"
          get-modflow "$MODFLOW_BIN_PATH" --repo ${{ inputs.repo }}
        else
          echo "get-modflow command not available, downloading get_modflow.py"
          script_path="$RUNNER_TEMP/get_modflow.py"
          curl https://raw.githubusercontent.com/modflowpy/flopy/develop/flopy/utils/get_modflow.py -o "$script_path"

          echo "running get_modflow.py"
          python3 $script_path "$MODFLOW_BIN_PATH" --repo "${{ inputs.repo }}"
        fi
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}

    - name: Add executables to path
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "adding bin dir '$MODFLOW_BIN_PATH' to path"
        echo "$MODFLOW_BIN_PATH" >> $GITHUB_PATH

    - name: Add executables to path (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        echo "adding bin dir '$env:MODFLOW_BIN_PATH' to path"
        echo $env:MODFLOW_BIN_PATH | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append